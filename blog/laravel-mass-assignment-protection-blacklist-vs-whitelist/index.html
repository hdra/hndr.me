<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <title>    Laravel Mass Assignment Protection - Blacklist V.S. Whitelist
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href='https://fonts.googleapis.com/css?family=Gentium+Book+Basic|Merriweather:400,300' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://hndr.me/theme/css/cid.css">
        <link href="https://hndr.me/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="HNDR.ME Atom Feed" />
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

            <div class="container">

<header class="blog-header">
    <h1><a href="https://hndr.me">HNDR.ME</a></h1>
    <p> A nerd pretending to be a software engineer. </p>
    <nav>
        <a href="https://hndr.me/blog">INDEX</a>
        <a href="https://hndr.me/archives">ARCHIVES</a>
        <a href="https://hndr.me/categories">CATEGORIES</a>
    </nav>
</header>

    <div class="post">

        <header>
            <h1>Laravel Mass Assignment Protection - Blacklist V.S.&nbsp;Whitelist</h1>
            <p class="date">Written on <time datetime="2014-07-12T18:55:00+08:00">Jul 12, 2014</time></p>
        </header>

        <article>
            <p><em><span class="caps">TLDR</span></em>: Use whitelist instead of blacklist. Laravel will attempt to mass-assign all attributes that aren’t in the blacklist, including properties/columns that aren’t on the table, causing <span class="caps">SQL</span>&nbsp;error.</p>
<p>In Laravel (At least on version 4.2.6), there is a convenient method to insert data into the&nbsp;database.</p>
<div class="highlight"><pre><span></span> <span class="cp">&lt;?php</span>
 <span class="c1">// ...</span>
 <span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">(</span><span class="nx">Input</span><span class="o">::</span><span class="na">all</span><span class="p">());</span>
</pre></div>


<p>So, the line of code above will take all of the form data and assign them to the <code>User</code> model’s attributes. This means that if we don’t put in any safe guard, anyone could modify the request parameters and set any value for any of the property. This could includes things like user’s roles and permissions, ids, or any other sensitive data. Of course, we could just assign the attributes one-by-one, but that would make our code a lot more&nbsp;verbose.</p>
<p>Fortunately, Laravel provide two easy ways to safeguard against this kind of mass assignment vulnerability. Either specify a list of fields that can be mass assigned (whitelist), or specify a list of fields that can’t be mass assigned (blacklist). While it seems like the two do the same thing, there are some subtle differences that could cause a bit of&nbsp;confusion.</p>
<p>For example, we got this table of&nbsp;User:</p>
<div class="highlight"><pre><span></span> <span class="cp">&lt;?php</span>
 <span class="c1">// ...</span>
 <span class="nx">Schema</span><span class="o">::</span><span class="na">create</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="nv">$table</span><span class="p">)</span>
 <span class="p">{</span>
      <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">increments</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">);</span>
      <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">string</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">);</span>
      <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">string</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">);</span>
      <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">unsignedInteger</span><span class="p">(</span><span class="s1">&#39;role&#39;</span><span class="p">);</span>
 <span class="p">});</span>
</pre></div>


<p>Say we want to protect the <code>role</code> field from being mass-assignment, so, there are two ways to do this in the <code>User</code> model. We can either specify a <code>guarded</code> property to specify a list of fields that we want to exclude from&nbsp;mass-assignment:</p>
<div class="highlight"><pre><span></span> <span class="cp">&lt;?php</span>
 <span class="c1">// ...</span>
 <span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">Eloquent</span><span class="p">{</span>
      <span class="k">public</span> <span class="nv">$timestamps</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
      <span class="k">protected</span> <span class="nv">$guarded</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">];</span>
 <span class="p">}</span>
</pre></div>


<p>Or we can specify a <code>fillable</code> property to specify a list of fields that we want to allow for&nbsp;mass-assignment:</p>
<div class="highlight"><pre><span></span> <span class="cp">&lt;?php</span>
 <span class="c1">// ...</span>
 <span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">Eloquent</span><span class="p">{</span>
      <span class="k">public</span> <span class="nv">$timestamps</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
      <span class="k">protected</span> <span class="nv">$fillable</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">];</span>
 <span class="p">}</span>
</pre></div>


<p>While you would most probably wouldn’t notice any difference, but let&#8217;s take a look at the Laravel’s <code>Model.php</code> source code. First, the code that perform the mass assignment&nbsp;operation.</p>
<div class="highlight"><pre><span></span> <span class="cp">&lt;?php</span>
 <span class="c1">// ...</span>
 <span class="k">public</span> <span class="k">function</span> <span class="nf">fill</span><span class="p">(</span><span class="k">array</span> <span class="nv">$attributes</span><span class="p">)</span>
 <span class="p">{</span>
      <span class="nv">$totallyGuarded</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">totallyGuarded</span><span class="p">();</span>

      <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fillableFromArray</span><span class="p">(</span><span class="nv">$attributes</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span>
      <span class="p">{</span>
           <span class="nv">$key</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">removeTableFromKey</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>

           <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isFillable</span><span class="p">(</span><span class="nv">$key</span><span class="p">))</span>
           <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
           <span class="p">}</span>
           <span class="k">elseif</span> <span class="p">(</span><span class="nv">$totallyGuarded</span><span class="p">)</span>
           <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">MassAssignmentException</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>
           <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
 <span class="p">}</span>
</pre></div>


<p>We can see that the code loop through the list fillable attributes via the <code>fillableFromArray</code> method, so let’s take a look at&nbsp;it.</p>
<div class="highlight"><pre><span></span> <span class="cp">&lt;?php</span>
 <span class="c1">// ...</span>
 <span class="k">protected</span> <span class="k">function</span> <span class="nf">fillableFromArray</span><span class="p">(</span><span class="k">array</span> <span class="nv">$attributes</span><span class="p">)</span>
 <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fillable</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="k">static</span><span class="o">::</span><span class="nv">$unguarded</span><span class="p">)</span>
      <span class="p">{</span>
           <span class="k">return</span> <span class="nb">array_intersect_key</span><span class="p">(</span><span class="nv">$attributes</span><span class="p">,</span> <span class="nb">array_flip</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fillable</span><span class="p">));</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nv">$attributes</span><span class="p">;</span>
 <span class="p">}</span>
</pre></div>


<p>The method check if we have any value in the <code>fillable</code> property, and if so, return a list of properties inside the <code>attributes</code> variable that intersect with the <code>fillable</code> array, else simply return the <code>attributes</code> itself. This means if we have a <code>fillable</code> property defined for our model, the mass assignment will not process that attributes that aren’t specified in the <code>fillable</code> property.</p>
<p>So, let’s move on to how Laravel guards the attributes in the <code>guarded</code> property. Let’s go back to the <code>fill</code> method. We can see that for every attributes, the method will check if the key is fillable by calling the <code>isFillable</code> method.</p>
<div class="highlight"><pre><span></span> <span class="cp">&lt;?php</span>
 <span class="c1">// ...</span>
 <span class="k">public</span> <span class="k">function</span> <span class="nf">isFillable</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span>
 <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">static</span><span class="o">::</span><span class="nv">$unguarded</span><span class="p">)</span> <span class="k">return</span> <span class="k">true</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fillable</span><span class="p">))</span> <span class="k">return</span> <span class="k">true</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isGuarded</span><span class="p">(</span><span class="nv">$key</span><span class="p">))</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span>

      <span class="k">return</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fillable</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="nx">starts_with</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">);</span>
 <span class="p">}</span>

 <span class="k">public</span> <span class="k">function</span> <span class="nf">isGuarded</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span>
 <span class="p">{</span>
      <span class="k">return</span> <span class="nb">in_array</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">guarded</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">guarded</span> <span class="o">==</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">);</span>
 <span class="p">}</span>
</pre></div>


<p>if the key is not listed in the <code>fillable</code> property,  it will call another method <code>isGuarded</code>, that checks if the key is specified in the <code>guarded</code> property.</p>
<p>This means, if <code>fillable</code> is not specified, and the key is not listed in the <code>guarded</code> property, the framework will assume that the key can be safely mass-assigned. Sound perfectly fine and should be expected, but when we include a property that is not a field of the table, it will cause an error, because the framework will try to insert a data into a column that doesn’t exists. The same problem will not occur if you use a while list since the framework will only process the keys that are in the&nbsp;array.</p>
<p>In conclusion, the best way to protect against mass-assignment vulnerability is to use the whitelist instead of the blacklist. From a security standpoint, it is better to explicitly specify the things that you want to allow anyway, and it also wouldn’t make Laravel try and insert the a non-existing field into the&nbsp;database.</p>
        </article>

        <footer>
            <p>This entry is posted in <a href="https://hndr.me/category/2014.html">2014</a>.</p>
        </footer>

<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'hndrblog';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

    </div>


<footer class="blog-footer">

    <ul class="nav">
                <li><a href="https://hndr.me/blog">Blog</a></li>
            <li><a href="https://github.com/hdra">Github</a></li>
            <li><a href="https://twitter.com/_hdra">Twitter</a></li>
    <script type="text/javascript">
        // JS ROT13 by http://techblog.tilllate.com/2008/07/20/ten-methods-to-obfuscate-e-mail-addresses-compared/
        document.write( "<yv><n uers=\"znvygb:uraqen2392@tznvy.pbz\" ery=\"absbyybj\">Rznvy</n></yv>".replace(/[a-zA-Z]/g, function(c){return String.fromCharCode((c<="Z"?90:122)>=(c=c.charCodeAt(0)+13)?c:c-26);}));
    </script>
    </ul>

    <p class="disclaimer">
        Contents is <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/us/">cc by-nc-sa</a>. All opinions are of my own.
    </p>
</footer>
            </div>
<script>
    var _gaq=[['_setAccount','UA-40075063-1'],['_trackPageview']];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
    g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g,s)}(document,'script'));
</script>
    </body>
</html>